import main
import json


def test_get_helm_deployments_status():
    helm_list = "agile-walrus\nanxious-ostrich\nappd-python-agent\nark\ncert-manager-eng\nchartmuseum"
    helm_list_results = main.get_helm_deployments_status(helm_list)

    assert len(helm_list_results) == 6


def test_get_helm_pods():
    deployments = [{u'info': {u'status': {u'notes': u'1. Get the application URL by running these commands:\n', u'code': 4}, u'last_deployed': {u'seconds': 1529590343, u'nanos': 658442077}, u'first_deployed': {u'seconds': 1529590343, u'nanos': 658442077}, u'Description': u'Release "agile-walrus" failed: Service in version "v1" cannot be handled as a Service: v1.Service: Spec: v1.ServiceSpec: Ports: []v1.ServicePort: v1.ServicePort: Port: readUint32: unexpected character: \ufffd, parsing 267 ...","port":n... at {"apiVersion":"v1","kind":"Service","metadata":{"labels":{"app":"sample-nodejs-app","chart":"sample-nodejs-app-0.1.0","heritage":"Tiller","release":"agile-walrus"},"name":"agile-walrus-sample-nodejs-app","namespace":"default"},"spec":{"ports":[{"name":"http","port":null,"protocol":"TCP","targetPort":"http"}],"selector":{"app":"sample-nodejs-app","release":"agile-walrus"},"type":"ClusterIP"}}'}, u'namespace': u'default', u'name': u'agile-walrus'}, {u'info': {u'status': {u'code': 4}, u'last_deployed': {u'seconds': 1549970021, u'nanos': 560122545}, u'first_deployed': {u'seconds': 1549970021, u'nanos': 560122545}, u'Description': u'Release "anxious-ostrich" failed: certificates.certmanager.k8s.io "nbs-banking-nempoc-ace-get-involved-parties-v2" already exists'}, u'namespace': u'pv-test', u'name': u'anxious-ostrich'}, {u'info': {u'status': {u'code': 1, u'resources': u'==> v1/Pod(related)\nNAME                                              READY   STATUS             RESTARTS   AGE\nappd-python-agent-appdyn-agent-6cdb8cc899-5kcwj   0/1     CrashLoopBackOff   123        4d9h\n\n==> v1/Service\nNAME                             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nappd-python-agent-appdyn-agent   ClusterIP   100.64.145.95   <none>        80/TCP    187d\n\n==> v1beta1/Deployment\nNAME                             READY   UP-TO-DATE   AVAILABLE   AGE\nappd-python-agent-appdyn-agent   0/1     1            0           187d\n\n'}, u'last_deployed': {u'seconds': 1556113151, u'nanos': 25491535}, u'first_deployed': {u'seconds': 1556112218, u'nanos': 645405420}, u'Description': u'Upgrade complete'}, u'namespace': u'vishal-test', u'name': u'appd-python-agent'}, {u'info': {u'status': {u'notes': u'Check that the ark is up and running:\n\nCheck that the secret has been created:\n\nOnce ark server is up and running you need the client before you can use it\n1. wget https://github.com/heptio/ark/releases/download/v0.9.9/ark-v0.9.9-darwin-amd64.tar.gz\n2. tar -xvf ark-v0.9.9-darwin-amd64.tar.gz -C ark-client\n\nMore info on the official site: https://github.com/heptio/ark#install-client\n', u'code': 1, u'resources': u'==> v1/ConfigMap\nNAME   DATA   AGE\nark    1      362d\nget-temp-creds   1     362d\n\n==> v1/Pod(related)\nNAME                   READY   STATUS    RESTARTS   AGE\nark-78b88bcb8b-ntpwm   2/2     Running   0          4d10h\n\n==> v1/ServiceAccount\nNAME       SECRETS   AGE\nark-hook   1         362d\nark-server   1     362d\n\n==> v1beta1/ClusterRole\nNAME       AGE\nark-hook   362d\n\n==> v1beta1/ClusterRoleBinding\nNAME       AGE\nark-hook   362d\nark-server   362d\n\n==> v1beta1/CustomResourceDefinition\nNAME                     AGE\nbackups.ark.heptio.com   362d\nconfigs.ark.heptio.com   362d\ndeletebackuprequests.ark.heptio.com   362d\ndownloadrequests.ark.heptio.com   362d\npodvolumebackups.ark.heptio.com   362d\npodvolumerestores.ark.heptio.com   362d\nresticrepositories.ark.heptio.com   362d\nrestores.ark.heptio.com   362d\nschedules.ark.heptio.com   362d\n\n==> v1beta2/Deployment\nNAME   READY   UP-TO-DATE   AVAILABLE   AGE\nark    1/1     1            1           362d\n\n'}, u'last_deployed': {
        u'seconds': 1540991874, u'nanos': 26147660}, u'first_deployed': {u'seconds': 1540991874, u'nanos': 26147660}, u'Description': u'Install complete'}, u'namespace': u'heptio-ark', u'name': u'ark'}, {u'info': {u'status': {u'code': 1, u'resources': u'==> v1/Secret\nNAME                           TYPE                DATA   AGE\ncert-manager-eng-ca-key-pair   kubernetes.io/tls   2      388d\n\n==> v1/ServiceAccount\nNAME               SECRETS   AGE\ncert-manager-eng   1         388d\n\n==> v1beta1/ClusterRole\nNAME               AGE\ncert-manager-eng   348d\n\n==> v1beta1/ClusterRoleBinding\nNAME               AGE\ncert-manager-eng   348d\n\n==> v1beta1/CustomResourceDefinition\nNAME                              AGE\ncertificates.certmanager.k8s.io   327d\nclusterissuers.certmanager.k8s.io   348d\nissuers.certmanager.k8s.io   348d\n\n==> MISSING\nKIND\t\tNAME\napps/v1beta1, Resource=deployments\t\tcert-manager-eng\n'}, u'last_deployed': {u'seconds': 1538741049, u'nanos': 291493694}, u'first_deployed': {u'seconds': 1538741049, u'nanos': 291493694}, u'Description': u'Install complete'}, u'namespace': u'infra-core', u'name': u'cert-manager-eng'}, {u'info': {u'status': {u'code': 1, u'resources': u'==> v1/Pod(related)\nNAME                                       READY   STATUS    RESTARTS   AGE\nchartmuseum-chartmuseum-7b65f4ffdd-vkk8j   1/1     Running   0          4d9h\n\n==> v1/Secret\nNAME                      TYPE     DATA   AGE\nchartmuseum-chartmuseum   Opaque   0      504d\n\n==> v1/Service\nNAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nchartmuseum-chartmuseum   ClusterIP   100.71.150.92   <none>        8080/TCP   504d\n\n==> v1beta1/Deployment\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\nchartmuseum-chartmuseum   1/1     1            1           504d\n\n'}, u'last_deployed': {u'seconds': 1528720925, u'nanos': 317873355}, u'first_deployed': {u'seconds': 1528720925, u'nanos': 317873355}, u'Description': u'Install complete'}, u'namespace': u'chartmuseum', u'name': u'chartmuseum'}]

    deployments_json = json.loads(json.dumps(deployments))

    expected = ['appd-python-agent-appdyn-agent-6cdb8cc899-5kcwj',
                'ark-78b88bcb8b-ntpwm', 'chartmuseum-chartmuseum-7b65f4ffdd-vkk8j']

    assert(main.get_helm_pods(deployments_json) == expected)


def test_generate_csv_file():
    all_pods_list = [{u'status': {u'qosClass': u'BestEffort', u'containerStatuses': [{u'restartCount': 0, u'name': u'tiller', u'image': u'gcr.io/kubernetes-helm/tiller:v2.8.2', u'imageID': u'docker-pullable://gcr.io/kubernetes-helm/tiller@sha256:9b373c71ea2dfdb7d42a6c6dada769cf93be682df7cfabb717748bdaef27d10a', u'state': {u'running': {u'startedAt': u'2019-10-25T01:16:51Z'}}, u'ready': True, u'lastState': {}, u'containerID': u'docker://fd1f2a7170c6e5dd92e86616f63f5020fc53b463a84b75897000bfb8d68a858e'}], u'podIP': u'100.126.253.246', u'startTime': u'2019-10-25T01:16:46Z', u'hostIP': u'172.18.0.250', u'phase': u'Running', u'conditions': [{u'status': u'True', u'lastTransitionTime': u'2019-10-25T01:16:46Z', u'lastProbeTime': None, u'type': u'Initialized'}, {u'status': u'True', u'lastTransitionTime': u'2019-10-25T01:16:58Z', u'lastProbeTime': None, u'type': u'Ready'}, {u'status': u'True', u'lastTransitionTime': u'2019-10-25T01:16:46Z', u'lastProbeTime': None, u'type': u'PodScheduled'}]}, u'kind': u'Pod', u'spec': {u'dnsPolicy': u'ClusterFirst', u'securityContext': {}, u'nodeName': u'ip-172-18-0-250.eu-west-2.compute.internal', u'schedulerName': u'default-scheduler', u'serviceAccount': u'admin-tiller', u'terminationGracePeriodSeconds': 30, u'restartPolicy': u'Always', u'volumes': [{u'secret': {u'defaultMode': 420, u'secretName': u'admin-tiller-token-f8qpc'}, u'name': u'admin-tiller-token-f8qpc'}], u'tolerations': [{u'operator': u'Exists', u'tolerationSeconds': 300, u'effect': u'NoExecute', u'key': u'node.kubernetes.io/not-ready'}, {u'operator': u'Exists', u'tolerationSeconds': 300, u'effect': u'NoExecute', u'key': u'node.kubernetes.io/unreachable'}], u'containers': [{u'livenessProbe': {u'httpGet': {u'path': u'/liveness', u'scheme': u'HTTP', u'port': 44135}, u'timeoutSeconds': 1, u'initialDelaySeconds': 1, u'periodSeconds': 10, u'successThreshold': 1, u'failureThreshold': 3}, u'terminationMessagePath': u'/dev/termination-log', u'name': u'tiller', u'image': u'gcr.io/kubernetes-helm/tiller:v2.8.2', u'volumeMounts': [{u'readOnly': True, u'mountPath': u'/var/run/secrets/kubernetes.io/serviceaccount', u'name': u'admin-tiller-token-f8qpc'}], u'terminationMessagePolicy': u'File', u'env': [{u'name': u'TILLER_NAMESPACE', u'value': u'admin-tiller'}, {u'name': u'TILLER_HISTORY_MAX', u'value': u'5'}], u'imagePullPolicy': u'IfNotPresent', u'readinessProbe': {u'httpGet': {u'path': u'/readiness', u'scheme': u'HTTP', u'port': 44135}, u'timeoutSeconds': 1, u'initialDelaySeconds': 1, u'periodSeconds': 10, u'successThreshold': 1, u'failureThreshold': 3}, u'ports': [{u'protocol': u'TCP', u'containerPort': 44134, u'name': u'tiller'}, {u'protocol': u'TCP', u'containerPort': 44135, u'name': u'http'}], u'resources': {}}], u'serviceAccountName': u'admin-tiller'}, u'apiVersion': u'v1', u'metadata': {u'name': u'tiller-deploy-86b8df859b-xw7l2', u'labels': {u'pod-template-hash': u'4264894156', u'app': u'helm', u'name': u'tiller'}, u'namespace': u'admin-tiller', u'ownerReferences': [{u'kind': u'ReplicaSet', u'uid': u'9c2ed059-5827-11e8-8939-0281a51a7f04', u'apiVersion': u'extensions/v1beta1', u'controller': True, u'blockOwnerDeletion': True, u'name': u'tiller-deploy-86b8df859b'}], u'resourceVersion': u'222169830', u'generateName': u'tiller-deploy-86b8df859b-', u'creationTimestamp': u'2019-10-25T01:16:46Z', u'selfLink': u'/api/v1/namespaces/admin-tiller/pods/tiller-deploy-86b8df859b-xw7l2', u'uid': u'1cc9671e-f6c5-11e9-97a4-02a1f4ea7622'}},
                     {u'status': {u'qosClass': u'BestEffort', u'containerStatuses': [{u'restartCount': 0, u'name': u'rsyslog', u'image': u'karthick9500/syslog:1.2', u'imageID': u'docker-pullable://karthick9500/syslog@sha256:d9949ba9793d37555ab9b80b1f305b298f3fed85f322af62ea402d812a27727b', u'state': {u'running': {u'startedAt': u'2019-10-25T00:06:17Z'}}, u'ready': True, u'lastState': {}, u'containerID': u'docker://fd4845717bf9c6b7a6c63eb888e95b4a546069167ba10731e34cb407ff711373'}], u'podIP': u'100.109.210.57', u'startTime': u'2019-10-25T00:06:13Z', u'hostIP': u'172.18.0.100', u'phase': u'Running', u'conditions': [{u'status': u'True', u'lastTransitionTime': u'2019-10-25T00:06:13Z', u'lastProbeTime': None, u'type': u'Initialized'}, {u'status': u'True', u'lastTransitionTime': u'2019-10-25T00:06:18Z', u'lastProbeTime': None, u'type': u'Ready'}, {u'status': u'True', u'lastTransitionTime': u'2019-10-25T00:06:13Z', u'lastProbeTime': None, u'type': u'PodScheduled'}]}, u'kind': u'Pod', u'spec': {u'dnsPolicy': u'ClusterFirst', u'securityContext': {}, u'nodeName': u'ip-172-18-0-100.eu-west-2.compute.internal', u'schedulerName': u'default-scheduler', u'serviceAccount': u'default', u'terminationGracePeriodSeconds': 30, u'restartPolicy': u'Always', u'volumes': [{u'hostPath': {u'path': u'/tmp', u'type': u'Directory'}, u'name': u'test-volume'}, {u'secret': {u'defaultMode': 420, u'secretName': u'default-token-m72nn'}, u'name': u'default-token-m72nn'}], u'tolerations': [{u'operator': u'Exists', u'tolerationSeconds': 300, u'effect': u'NoExecute', u'key': u'node.kubernetes.io/not-ready'}, {u'operator': u'Exists', u'tolerationSeconds': 300, u'effect': u'NoExecute', u'key': u'node.kubernetes.io/unreachable'}], u'containers': [{u'terminationMessagePath': u'/dev/termination-log', u'name': u'rsyslog', u'image': u'karthick9500/syslog:1.2', u'volumeMounts': [{u'mountPath': u'/var/local', u'name': u'test-volume'}, {u'readOnly': True, u'mountPath': u'/var/run/secrets/kubernetes.io/serviceaccount', u'name': u'default-token-m72nn'}], u'terminationMessagePolicy': u'File', u'imagePullPolicy': u'Always', u'ports': [{u'protocol': u'TCP', u'containerPort': 514, u'name': u'incoming-logs'}], u'resources': {}}], u'serviceAccountName': u'default'}, u'apiVersion': u'v1', u'metadata': {u'name': u'rsyslog-6f554bfc7d-nppd5', u'labels': {u'pod-template-hash': u'2911069738', u'app': u'rsyslog'}, u'namespace': u'apigee-ops', u'ownerReferences': [{u'kind': u'ReplicaSet', u'uid': u'c2eb274e-c4c7-11e9-8526-0a964a72eac8', u'apiVersion': u'extensions/v1beta1', u'controller': True, u'blockOwnerDeletion': True, u'name': u'rsyslog-6f554bfc7d'}], u'resourceVersion': u'222138121', u'generateName': u'rsyslog-6f554bfc7d-', u'creationTimestamp': u'2019-10-25T00:06:13Z', u'selfLink': u'/api/v1/namespaces/apigee-ops/pods/rsyslog-6f554bfc7d-nppd5', u'uid': u'4209bddf-f6bb-11e9-bc99-0a9c2ca7b4dc'}}]

    all_pods = json.loads(json.dumps(all_pods_list))

    helm_pods = ['appd-python-agent-appdyn-agent-6cdb8cc899-5kcwj',
                 'ark-78b88bcb8b-ntpwm', 'chartmuseum-chartmuseum-7b65f4ffdd-vkk8j']

    expected = [['Name', 'Image', 'App', 'Created At', 'Deployment Method'], [u'tiller-deploy-86b8df859b-xw7l2', u'gcr.io/kubernetes-helm/tiller:v2.8.2',
                                                                              '', u'2019-10-25T01:16:46Z', ''], [u'rsyslog-6f554bfc7d-nppd5', u'karthick9500/syslog:1.2', '', u'2019-10-25T00:06:13Z', '']]
    assert(main.generate_csv_file(all_pods, helm_pods) == expected)
